<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±TRPG 6ç‰ˆ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆ (Ver 6.6)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
    <style>
        /* ==================== åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« ==================== */
        body { font-family: 'Yu Gothic', 'Meiryo', sans-serif; margin: 0; background-color: #f0f0f0; font-size: 13px; color: #333; }
        .sheet-container { 
            width: 800px; margin: 10px auto; padding: 20px; 
            background: white; border: 1px solid #333; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
            box-sizing: border-box; 
        }
        h2 { 
            font-size: 1.2em; border-bottom: 2px solid #333; 
            padding-bottom: 3px; margin: 15px 0 10px 0; 
        }
        
        .input-line { display: inline-block; border-bottom: 1px solid #333; padding: 0 2px; margin-right: 5px; font-size: 0.9em; vertical-align: bottom; }
        .input-line input, .input-line select { border: none; background: transparent; padding: 2px; text-align: center; font-size: 1em; width: 100%; box-sizing: border-box; }
        .label { font-weight: bold; margin-right: 3px; white-space: nowrap; }

        #top-section { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 15px; }
        #basic-info-details { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        #name-job-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        #details-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; align-items: center; }
        #name-job-row > div, #details-row > div { display: flex; align-items: center; }
        .input-line { flex-grow: 1; }

        /* ç”»åƒã‚¨ãƒªã‚¢ */
        #image-wrapper {
            width: 300px; height: 220px; 
            border: 1px dashed #ccc; background-color: #fafafa;
            background-size: contain; background-position: 50% 50%; 
            background-repeat: no-repeat; cursor: pointer; position: relative; flex-shrink: 0;
        }
        #image-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #888; width: 100%; text-align: center; pointer-events: none; }
        #char-image-file { display: none; }

        /* ãƒ¡ãƒ¢æ¬„ */
        #memo-area textarea { 
            width: 100%; height: 80px; border: 1px solid #ccc; padding: 5px; 
            box-sizing: border-box; resize: vertical; font-family: inherit; line-height: 1.5;
        }
        .memo-capture-div { width: 100%; min-height: 80px; border: 1px solid #ccc; padding: 5px; box-sizing: border-box; display: none; white-space: pre-wrap; word-break: break-word; font-family: inherit; line-height: 1.5; }

        /* èƒ½åŠ›å€¤ (ã‚¹ãƒšãƒ¼ã‚¹çŸ­ç¸® & å³æƒãˆ) */
        .stats-grid-unified { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stats-grid-unified label { 
            display: flex; 
            justify-content: flex-end; /* ğŸŒŸ ã“ã“ã‚’å¤‰æ›´: å³å¯„ã›ã«ã—ã¦é–“éš”ã‚’è©°ã‚ã‚‹ ğŸŒŸ */
            align-items: center;
            gap: 8px; /* æ–‡å­—ã¨æ ã®é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            white-space: nowrap; 
            font-size: 1em; 
            margin-bottom: 2px; 
        }
        .stats-grid-unified input { width: 55px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 1.1em; }

        /* æ´¾ç”Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (Ver 6.2ä»•æ§˜) */
        #derived-stats-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 10px; }
        .derived-item span { font-size: 1em; display: block; margin-bottom: 2px; }
        .derived-item input { width: 100%; font-size: 1.2em; padding: 3px; box-sizing: border-box; text-align: center; }

        /* æŠ€èƒ½ãƒªã‚¹ãƒˆ */
        #skills-wrapper { border: 1px solid #333; padding: 10px; margin-top: 15px; }
        .skill-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .skill-grid-structure { 
            display: grid; 
            grid-template-columns: 2.2fr 0.8fr 1fr 1fr 1fr 1fr 0.4fr; 
            gap: 2px; align-items: center; text-align: center; font-size: 0.9em; 
        }
        
        .skill-header { font-weight: bold; border-bottom: 1px solid #333; margin-bottom: 5px; padding-bottom: 3px; }
        .skill-header span:first-child { text-align: left; }
        .skill-item { border-bottom: 1px dotted #eee; padding: 2px 0; height: 1.6em; } 
        
        .skill-name-container { display: flex; align-items: center; text-align: left; overflow: hidden; white-space: nowrap; }
        .skill-name { margin-right: 4px; }
        .sub-skill-input { border: none; border-bottom: 1px solid #999; background: transparent; font-size: 0.9em; width: 70px; color: #555; padding: 0 2px; }
        .sub-skill-input::placeholder { color: #ccc; font-size: 0.8em; }

        .skill-item input[type="number"] { width: 100%; text-align: center; border: none; border-bottom: 1px solid #ccc; background: #f9f9f9; padding: 0; font-size: 1em; }
        .skill-total { font-weight: bold; }

        /* ãƒœã‚¿ãƒ³ç¾¤ */
        .utility-buttons { text-align: center; margin: 15px auto; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .utility-buttons button { padding: 8px 12px; cursor: pointer; border-radius: 4px; color: white; border: none; font-size: 13px; font-weight: bold; }
        .export-png-btn { background-color: #ffc107; color: #333; }
        .roll-btn { background-color: #28a745; }
        .print-btn { background-color: #007bff; }
        .clear-btn { background-color: #dc3545; }
        .csv-btn { background-color: #17a2b8; }
        .coco-btn { background-color: #0056b3; }
        .ia-btn { background-color: #6f42c1; }

        /* ==================== å°åˆ·ç”¨CSS ==================== */
        @media print {
            @page { size: A4; margin: 0; } 
            body { background: white; -webkit-print-color-adjust: exact; height: 100%; zoom: 0.8; }
            .utility-buttons { display: none !important; }
            .sheet-container { width: 94% !important; max-width: 800px; margin: 10mm auto !important; padding: 0 !important; border: none !important; box-shadow: none !important; }
            h2 { margin: 8px 0 !important; font-size: 1.1em; padding-bottom: 2px; }
            #top-section { margin-bottom: 10px !important; gap: 15px !important; }
            #basic-info-details { gap: 5px !important; }
            #name-job-row, #details-row { gap: 10px !important; margin-bottom: 5px !important; }
            #image-wrapper { height: 180px !important; border: 1px solid #ccc !important; width: 280px !important; }
            #memo-area textarea { height: 60px !important; padding: 3px !important; } 
            .stats-grid-unified { margin-bottom: 10px !important; gap: 8px !important; }
            .stats-grid-unified label { font-size: 0.95em; margin-bottom: 0; }
            .stats-grid-unified input { padding: 2px; font-size: 1em; height: 1.5em; }
            #derived-stats-section { margin-top: 10px !important; gap: 10px !important; }
            .derived-item span { font-size: 0.95em; margin-bottom: 0; }
            .derived-item input { padding: 2px; font-size: 1.1em; height: 1.5em; }
            .summary { margin-top: 10px !important; margin-bottom: 10px !important; font-size: 0.9em; padding: 4px !important; }
            #skills-wrapper { padding: 5px !important; margin-top: 10px !important; border-width: 1px !important; }
            .skill-columns { gap: 10px !important; }
            .skill-header { margin-bottom: 3px !important; font-size: 0.85em; }
            .skill-item { height: 1.65em !important; font-size: 9.5pt !important; padding: 0 !important; border-bottom: 1px dotted #ccc; display: flex; align-items: center; }
            .skill-grid-structure { display: grid; }
            .skill-item input[type="number"] { height: 1.3em; font-size: 1em; padding: 0 !important; border-bottom: none !important; }
            .sub-skill-input { width: 60px !important; font-size: 0.9em !important; border-bottom: none !important; }
            .sheet-container, #skills-wrapper, .skill-columns, .skill-item { page-break-inside: avoid !important; break-inside: avoid !important; }
        }
    </style>
</head>
<body>

<input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="importCSV(this)">

<div class="utility-buttons">
    <button class="ia-btn" onclick="importIachara()">ã„ã‚ãã‚ƒã‚‰èª­è¾¼</button>
    <button class="roll-btn" onclick="rollStats()">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æŒ¯</button>
    <button class="roll-btn" onclick="calculateDerivedStats()">è¨ˆç®—</button>
    <button class="coco-btn" onclick="copyCocoData()">ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢é§’ã‚³ãƒ”ãƒ¼</button>
    
    <button class="csv-btn" onclick="exportCSV()">CSVå‡ºåŠ›</button>
    <button class="csv-btn" onclick="document.getElementById('csv-file-input').click()">CSVèª­è¾¼</button>
    <button class="export-png-btn" onclick="exportPNG()">ç”»åƒä¿å­˜</button>
    <button class="print-btn" onclick="window.print()">PDFå°åˆ·</button>
    <button class="clear-btn" onclick="clearLocalStorage()">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div class="sheet-container" id="character-sheet">
    <div style="font-weight:bold; font-size:1.4em; text-align:center; margin-bottom:10px; border-bottom: 3px double #333; padding-bottom: 5px;">ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±TRPG 6ç‰ˆ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆ</div>

    <div id="top-section">
        <div id="basic-info-details">
            <div id="name-job-row">
                <div><span class="label">åå‰:</span><span class="input-line"><input type="text" id="char-name" oninput="saveData()"></span></div>
                <div><span class="label">è·æ¥­:</span><span class="input-line"><input type="text" id="char-job" oninput="saveData()"></span></div>
            </div>
            <div id="details-row">
                <div><span class="label">å‡ºèº«:</span><span class="input-line"><input type="text" id="char-country" oninput="saveData()"></span></div>
                <div><span class="label">æ€§åˆ¥:</span><span class="input-line"><select id="char-gender" onchange="saveData()"><option value="ä¸æ˜">ä¸æ˜</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option><option value="ãã®ä»–">ãã®ä»–</option></select></span></div>
                <div><span class="label">å¹´é½¢:</span><span class="input-line"><input type="number" id="char-age" value="20" oninput="saveData()"></span></div>
            </div>
            <div id="memo-area">
                <h3 style="font-size: 1em; margin: 5px 0;">æ‰€æŒå“ãƒ»ãƒ¡ãƒ¢</h3>
                <textarea id="items-memo" oninput="saveData()"></textarea>
                <div id="items-memo-capture" class="memo-capture-div"></div>
            </div>
        </div>
        
        <div id="image-wrapper">
            <input type="file" id="char-image-file" accept="image/*">
            <div id="image-placeholder">ç”»åƒã‚’é¸æŠ</div>
        </div>
    </div>

    <h2>èƒ½åŠ›å€¤</h2>
    <div class="stats-grid-unified">
        <label>STR (3d6): <input type="number" id="str" min="1" max="18" oninput="saveData()"></label>
        <label>CON (3d6): <input type="number" id="con" min="1" max="18" oninput="saveData()"></label>
        <label>SIZ (2d6+6): <input type="number" id="siz" min="8" max="18" oninput="saveData()"></label>
        <label>INT (2d6+6): <input type="number" id="int" min="8" max="18" oninput="saveData()"></label>
        <label>POW (3d6): <input type="number" id="pow" min="1" max="18" oninput="saveData()"></label>
        <label>DEX (3d6): <input type="number" id="dex" min="1" max="18" oninput="saveData()"></label>
        <label>APP (3d6): <input type="number" id="app" min="1" max="18" oninput="saveData()"></label>
        <label>EDU (3d6+3): <input type="number" id="edu" min="6" max="21" oninput="saveData()"></label>
    </div>

    <h2>æ´¾ç”Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
    <div id="derived-stats-section">
        <div class="derived-item"><span>SAN</span><input type="number" id="san" oninput="saveData()"><span>MP</span><input type="number" id="mp" oninput="saveData()"></div>
        <div class="derived-item"><span>è€ä¹…åŠ›(ç¾)</span><input type="number" id="totsu" oninput="saveData()"><span>è€ä¹…åŠ›(æœ€å¤§)</span><input type="number" id="hp-max" readonly></div>
        <div class="derived-item"><span>ã‚¢ã‚¤ãƒ‡ã‚¢</span><input type="number" id="idea" readonly><span>å¹¸é‹</span><input type="number" id="luck" readonly></div>
        <div class="derived-item"><span>çŸ¥è­˜</span><input type="number" id="know" readonly><span>DB</span><input type="text" id="db" readonly></div>
    </div>

    <div class="summary" style="margin-top: 10px; font-size: 0.95em; padding: 5px; background: #f9f9f9; border-radius: 4px;">
        è·æ¥­P(EDUÃ—20): <span id="job-points-max-display" style="font-weight:bold;">0</span> (æ¶ˆè²»:<span id="job-points-used">0</span>) <span id="job-point-alert" style="color:red;display:none;font-weight:bold;">OVER!</span> &nbsp;/&nbsp; 
        è¶£å‘³P(INTÃ—10): <span id="hobby-points-max-display" style="font-weight:bold;">0</span> (æ¶ˆè²»:<span id="hobby-points-used">0</span>) <span id="hobby-point-alert" style="color:red;display:none;font-weight:bold;">OVER!</span>
    </div>

    <h2 style="margin-top: 15px;">æŠ€èƒ½</h2>
    <div id="skills-wrapper">
        <div class="skill-columns">
            <div class="skill-column-container">
                <div class="skill-header skill-grid-structure" id="header-column-1">
                    <span>æŠ€èƒ½å</span><span>åˆæœŸ</span><span>è·æ¥­+</span><span>è¶£å‘³+</span><span>æˆé•·+</span><span>åˆè¨ˆ</span><span></span>
                </div>
                <div id="skills-column-1"></div>
            </div>
            <div class="skill-column-container">
                <div class="skill-header skill-grid-structure" id="header-column-2">
                    <span>æŠ€èƒ½å</span><span>åˆæœŸ</span><span>è·æ¥­+</span><span>è¶£å‘³+</span><span>æˆé•·+</span><span>åˆè¨ˆ</span><span></span>
                </div>
                <div id="skills-column-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const skills = { "å›é¿": { initial: 0, stat: "DEX" }, "ã‚­ãƒƒã‚¯": { initial: 25 }, "çµ„ä»˜ã": { initial: 25 }, "ã“ã¶ã—": { initial: 50 }, "é ­çªã": { initial: 10 }, "ãƒãƒ¼ã‚·ãƒ£ãƒ«ã‚¢ãƒ¼ãƒ„": { initial: 1 }, "æ‹³éŠƒ": { initial: 20 }, "ã‚µãƒ–ãƒã‚·ãƒ³ã‚¬ãƒ³": { initial: 15 }, "ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³": { initial: 30 }, "ãƒã‚·ãƒ³ã‚¬ãƒ³": { initial: 15 }, "ãƒ©ã‚¤ãƒ•ãƒ«": { initial: 25 }, "æŠ•æ“²": { initial: 25 }, "å¿œæ€¥æ‰‹å½“": { initial: 30 }, "åŒ»å­¦": { initial: 5 }, "éš ã™": { initial: 15 }, "éš å¯†": { initial: 10 }, "å¿ã³æ­©ã": { initial: 10 }, "èãè€³": { initial: 25 }, "å†™çœŸè¡“": { initial: 10 }, "å¿ƒç†å­¦": { initial: 5 }, "è¿½è·¡": { initial: 10 }, "å›³æ›¸é¤¨": { initial: 25 }, "ç›®æ˜Ÿ": { initial: 25 }, "è¨€ã„ãã‚‹ã‚": { initial: 5 }, "ä¿¡ç”¨": { initial: 15 }, "èª¬å¾—": { initial: 15 }, "å€¤åˆ‡ã‚Š": { initial: 5 }, "æ¯å›½èª": { initial: 0, stat: "EDU" }, "å¤–å›½èª": { initial: 1, sub: true }, "é‹è»¢": { initial: 20 }, "æ©Ÿæ¢°ä¿®ç†": { initial: 20 }, "é‡æ©Ÿæ¢°æ“ä½œ": { initial: 1 }, "ä¹—é¦¬": { initial: 5 }, "æ°´æ³³": { initial: 25 }, "è£½ä½œ": { initial: 5, sub: true }, "æ“ç¸¦": { initial: 1, sub: true }, "è·³èº": { initial: 25 }, "é›»æ°—ä¿®ç†": { initial: 10 }, "ãƒŠãƒ“ã‚²ãƒ¼ãƒˆ": { initial: 10 }, "å¤‰è£…": { initial: 1 }, "é‘‘å®š": { initial: 5 }, "è€ƒå¤å­¦": { initial: 1 }, "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼": { initial: 1 }, "é›»å­å·¥å­¦": { initial: 1 }, "éµé–‹ã‘": { initial: 1 }, "åœ°è³ªå­¦": { initial: 1 }, "åšç‰©å­¦": { initial: 10 }, "åŒ–å­¦": { initial: 1 }, "ç‰©ç†å­¦": { initial: 1 }, "ç”Ÿç‰©å­¦": { initial: 1 }, "è–¬å­¦": { initial: 1 }, "æ­´å²": { initial: 20 }, "æ³•å¾‹": { initial: 5 }, "çµŒç†": { initial: 10 }, "ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±": { initial: 0 }, "èŠ¸è¡“/å·¥èŠ¸": { initial: 5, sub: true }, "ã‚ªã‚«ãƒ«ãƒˆ": { initial: 5 }, "ç²¾ç¥åˆ†æ": { initial: 1 }, "æ‰‹ã•ã°ã": { initial: 10 }, "å¤©æ–‡å­¦": { initial: 1 }, "äººé¡å­¦": { initial: 1 }, "å‹•ç‰©ä½¿ã„": { initial: 1 }, "ç™»æ”€": { initial: 40 }, "çˆ†ç ´": { initial: 1 } };
    
    function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function rollDice(n, x) { let total = 0; for(let i=0; i<n; i++) total += Math.floor(Math.random()*x)+1; return total; }
    function calcDB(str, siz) { const t = str+siz; if(t<=12)return"-1d6"; if(t<=16)return"-1d4"; if(t<=24)return"0"; if(t<=32)return"+1d4"; if(t<=40)return"+1d6"; return"+2d6"; }

    const KEY_DATA = 'CoC6_Data';
    const KEY_IMG = 'CoC6_Img';

    function saveData() {
        const data = { skills: {} };
        document.querySelectorAll('input:not([type="file"]), select, textarea').forEach(el => data[el.id] = el.value);
        Object.keys(skills).forEach(k => {
            const j = document.getElementById(`s-${k}-job`);
            const h = document.getElementById(`s-${k}-hobby`);
            const g = document.getElementById(`s-${k}-growth`);
            const s = document.getElementById(`s-${k}-sub`);
            if(j && h && g) {
                let obj = { j: j.value, h: h.value, g: g.value };
                if(s) obj.sub = s.value;
                data.skills[k] = obj;
            }
        });
        localStorage.setItem(KEY_DATA, JSON.stringify(data));
        updateDerivedDisplay();
    }

    function loadData() {
        const d = JSON.parse(localStorage.getItem(KEY_DATA));
        if(d) {
            Object.keys(d).forEach(k => { if(k!=='skills'){ const el=document.getElementById(k); if(el) el.value=d[k]; }});
            if(d.skills) Object.keys(d.skills).forEach(k => {
                const s = d.skills[k];
                const j = document.getElementById(`s-${k}-job`);
                const h = document.getElementById(`s-${k}-hobby`);
                const g = document.getElementById(`s-${k}-growth`);
                const sub = document.getElementById(`s-${k}-sub`);
                if(j) j.value = s.j || 0; 
                if(h) h.value = s.h || 0;
                if(g) g.value = s.g || 0; 
                if(sub && s.sub) sub.value = s.sub;
            });
        }
        const img = localStorage.getItem(KEY_IMG);
        if(img) setBgImage(img);
        updateDerivedDisplay();
    }

    function setBgImage(url) {
        const area = document.getElementById('image-wrapper');
        const ph = document.getElementById('image-placeholder');
        area.style.backgroundImage = `url(${url})`;
        ph.style.display = 'none';
    }

    function rollStats() {
        ['str','con','pow','dex','app'].forEach(id => document.getElementById(id).value = rollDice(3,6));
        ['siz','int'].forEach(id => document.getElementById(id).value = rollDice(2,6)+6);
        document.getElementById('edu').value = rollDice(3,6)+3;
        calculateDerivedStats();
        saveData();
    }
    
    function calculateDerivedStats() {
        const v = (id) => parseInt(document.getElementById(id).value)||0;
        const maxHP = Math.floor((v('con')+v('siz'))/2);
        document.getElementById('hp-max').value = maxHP;
        document.getElementById('totsu').value = maxHP;
        document.getElementById('mp').value = v('pow');
        document.getElementById('san').value = v('pow') * 5;
        document.getElementById('idea').value = v('int')*5;
        document.getElementById('know').value = v('edu')*5;
        document.getElementById('luck').value = v('pow')*5;
        document.getElementById('db').value = calcDB(v('str'), v('siz'));
        updateDerivedDisplay();
        saveData();
    }
    
    function updateDerivedDisplay() {
        const v = (id) => parseInt(document.getElementById(id).value)||0;
        const jobMax = v('edu')*20, hobbyMax = v('int')*10;
        let jobUsed=0, hobbyUsed=0;
        Object.keys(skills).forEach(k => {
            const j = v(`s-${k}-job`);
            const h = v(`s-${k}-hobby`);
            const g = v(`s-${k}-growth`);
            jobUsed += j; hobbyUsed += h;
            let init = skills[k].initial;
            if(k==='æ¯å›½èª') init = v('edu')*5;
            if(k==='å›é¿') init = v('dex')*2; 
            const total = init + j + h + g;
            document.getElementById(`s-${k}-init`).innerText = init;
            const totEl = document.getElementById(`s-${k}-total`);
            totEl.innerText = total;
            totEl.style.color = (total > 99 && k!=='ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±') ? 'red' : 'black';
        });
        document.getElementById('job-points-max-display').innerText = jobMax;
        document.getElementById('job-points-used').innerText = jobUsed;
        document.getElementById('job-point-alert').style.display = jobUsed > jobMax ? 'inline' : 'none';
        document.getElementById('hobby-points-max-display').innerText = hobbyMax;
        document.getElementById('hobby-points-used').innerText = hobbyUsed;
        document.getElementById('hobby-point-alert').style.display = hobbyUsed > hobbyMax ? 'inline' : 'none';
    }

    function initSkills() {
        const c1 = document.getElementById('skills-column-1'), c2 = document.getElementById('skills-column-2');
        c1.innerHTML = ''; c2.innerHTML = '';
        const keys = Object.keys(skills);
        const split = Math.ceil(keys.length/2);
        keys.forEach((k, i) => {
            const div = document.createElement('div');
            div.className = 'skill-item skill-grid-structure';
            let nameHtml = `<span class="skill-name">${k}</span>`;
            if(skills[k].sub) {
                nameHtml = `<div class="skill-name-container"><span class="skill-name">${k}</span><input type="text" id="s-${k}-sub" class="sub-skill-input" placeholder="è©³ç´°" oninput="saveData()"></div>`;
            }
            div.innerHTML = `
                ${nameHtml}
                <span id="s-${k}-init">${skills[k].initial}</span>
                <input type="number" id="s-${k}-job" value="0" min="0" oninput="saveData()">
                <input type="number" id="s-${k}-hobby" value="0" min="0" oninput="saveData()">
                <input type="number" id="s-${k}-growth" value="0" min="0" oninput="saveData()">
                <span class="skill-total" id="s-${k}-total">0</span><span>%</span>
            `;
            (i < split ? c1 : c2).appendChild(div);
        });
        loadData();
    }
    
    function copyCocoData() {
        const v = (id) => document.getElementById(id).value;
        const name = v('char-name');
        const params = [
            { label: "STR", value: v('str') }, { label: "CON", value: v('con') },
            { label: "POW", value: v('pow') }, { label: "DEX", value: v('dex') },
            { label: "APP", value: v('app') }, { label: "SIZ", value: v('siz') },
            { label: "INT", value: v('int') }, { label: "EDU", value: v('edu') }
        ];
        const status = [
            { label: "HP", value: parseInt(v('totsu')||0), max: parseInt(v('hp-max')||0) },
            { label: "MP", value: parseInt(v('mp')||0), max: parseInt(v('mp')||0) },
            { label: "SAN", value: parseInt(v('san')||0), max: parseInt(v('san')||0) } 
        ];
        let commands = `1d100<={SAN} ã€æ­£æ°—åº¦ãƒ­ãƒ¼ãƒ«ã€‘\nCCB<=70 ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã€‘\nCCB<=45 ã€å¹¸é‹ã€‘\nCCB<=70 ã€çŸ¥è­˜ã€‘\n`;
        Object.keys(skills).forEach(k => {
            const total = document.getElementById(`s-${k}-total`).innerText;
            const subEl = document.getElementById(`s-${k}-sub`);
            let displayName = k;
            if(subEl && subEl.value) { displayName += `ï¼ˆ${subEl.value}ï¼‰`; }
            if (parseInt(total) > skills[k].initial || ["ç›®æ˜Ÿ","èãè€³","å›³æ›¸é¤¨","å›é¿"].includes(k) || subEl && subEl.value) {
                 commands += `CCB<=${total} ã€${displayName}ã€‘\n`;
            }
        });
        commands += `CCB<={STR}*5 ã€STR Ã— 5ã€‘\nCCB<={CON}*5 ã€CON Ã— 5ã€‘\nCCB<={POW}*5 ã€POW Ã— 5ã€‘\nCCB<={DEX}*5 ã€DEX Ã— 5ã€‘\nCCB<={APP}*5 ã€APP Ã— 5ã€‘\nCCB<={SIZ}*5 ã€SIZ Ã— 5ã€‘\nCCB<={INT}*5 ã€INT Ã— 5ã€‘\nCCB<={EDU}*5 ã€EDU Ã— 5ã€‘\n`;
        const data = {
            kind: "character",
            data: { name: name, initiative: parseInt(v('dex')||0), commands: commands, status: status, params: params }
        };
        navigator.clipboard.writeText(JSON.stringify(data)).then(() => {
            alert("ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢ç”¨ã®é§’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        });
    }

    function importIachara() {
        const jsonStr = prompt("ã„ã‚ãã‚ƒã‚‰ã§ã€Œã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢é§’å‡ºåŠ›ã€ã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’\nã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š");
        if (!jsonStr) return;
        try {
            const raw = JSON.parse(jsonStr);
            const d = raw.data;
            if(!d) throw new Error("Format Error");
            document.getElementById('char-name').value = d.name || "";
            if(d.params) d.params.forEach(p => { 
                const el = document.getElementById(p.label.toLowerCase()); 
                if(el) el.value = p.value; 
            });
            if(d.status) d.status.forEach(s => {
                if(s.label==="HP") { document.getElementById('hp-max').value=s.max; document.getElementById('totsu').value=s.value; }
                if(s.label==="MP") document.getElementById('mp').value=s.value;
                if(s.label==="SAN") document.getElementById('san').value=s.value;
            });
            if(d.commands) {
                Object.keys(skills).forEach(k => {
                   document.getElementById(`s-${k}-job`).value=0; 
                   document.getElementById(`s-${k}-hobby`).value=0;
                   document.getElementById(`s-${k}-growth`).value=0;
                   const sub = document.getElementById(`s-${k}-sub`);
                   if(sub) sub.value = "";
                });
                const lines = d.commands.split('\n');
                lines.forEach(line => {
                    const match = line.match(/<=(\d+).*?ã€(.*?)ã€‘/);
                    if(match) {
                        const val = parseInt(match[1]);
                        let fullName = match[2];
                        let name = fullName.replace(/ï¼ˆ.*?ï¼‰/g, ''); 
                        const subMatch = fullName.match(/ï¼ˆ(.*?)ï¼‰/);
                        let subValue = subMatch ? subMatch[1] : "";
                        if(skills[name]) {
                            let init = skills[name].initial;
                            const edu=parseInt(document.getElementById('edu').value)||0;
                            const dex=parseInt(document.getElementById('dex').value)||0;
                            if(name==='æ¯å›½èª') init=edu*5;
                            if(name==='å›é¿') init=dex*2;
                            const growth = Math.max(0, val - init);
                            document.getElementById(`s-${name}-growth`).value = growth;
                            const subEl = document.getElementById(`s-${name}-sub`);
                            if(subEl && subValue) subEl.value = subValue;
                        }
                    }
                });
            }
            saveData();
            alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼");
        } catch(e) {
            console.error(e);
            alert("èª­ã¿è¾¼ã¿å¤±æ•—ã€‚æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
        }
    }

    function exportCSV() {
        const inputs = document.querySelectorAll('input:not([type="file"]), select, textarea');
        let csv = "data:text/csv;charset=utf-8,ID,Value\n";
        inputs.forEach(el => {
            if(el.id) {
                let val = el.value.replace(/"/g, '""').replace(/\n/g, '\\n');
                csv += `${el.id},"${val}"\n`;
            }
        });
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = (document.getElementById('char-name').value || 'character') + '_data.csv';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function importCSV(input) {
        if (!input.files[0]) return;
        const r = new FileReader();
        r.onload = e => {
            const rows = e.target.result.split(/\r?\n/);
            rows.forEach((row, i) => {
                if(i===0 || !row.trim()) return;
                const idx = row.indexOf(',');
                if(idx === -1) return;
                const id = row.substring(0, idx);
                let val = row.substring(idx+1).replace(/^"|"$/g, '').replace(/""/g, '"').replace(/\\n/g, '\n');
                const el = document.getElementById(id);
                if(el) el.value = val;
            });
            saveData();
            alert("èª­ã¿è¾¼ã¿å®Œäº†");
            input.value = '';
        };
        r.readAsText(input.files[0]);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const imageArea = document.getElementById('image-wrapper'); 
        const imageFile = document.getElementById('char-image-file'); 
        imageArea.addEventListener('click', () => { imageFile.click(); });
        imageFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) { 
                    const base64Image = e.target.result; 
                    setBgImage(base64Image);
                    localStorage.setItem(KEY_IMG, base64Image); 
                }
                reader.readAsDataURL(file);
            }
        });
    });

    function exportPNG() {
        const sheet = document.getElementById('character-sheet');
        const txt = document.getElementById('items-memo');
        const div = document.getElementById('items-memo-capture');
        if(txt && div) {
            div.innerHTML = txt.value.replace(/\n/g, '<br>');
            txt.style.display = 'none'; div.style.display = 'block';
        }

        // è©³ç´°æ¬„ã®ãƒ†ã‚­ã‚¹ãƒˆåŒ–
        const subInputs = document.querySelectorAll('.sub-skill-input');
        const tempSpans = [];
        subInputs.forEach(input => {
            const span = document.createElement('span');
            span.style.fontSize = window.getComputedStyle(input).fontSize;
            span.style.fontFamily = window.getComputedStyle(input).fontFamily;
            span.style.borderBottom = window.getComputedStyle(input).borderBottom;
            span.style.display = 'inline-block';
            span.style.width = window.getComputedStyle(input).width;
            span.style.textAlign = 'left'; 
            span.style.padding = '0 2px';
            span.innerText = input.value;
            input.parentNode.insertBefore(span, input.nextSibling);
            input.style.display = 'none';
            tempSpans.push({ input: input, span: span });
        });

        // æ•°å€¤æ¬„ã®ãƒ†ã‚­ã‚¹ãƒˆåŒ–
        const numInputs = sheet.querySelectorAll('input[type="number"]');
        const tempNumSpans = [];
        numInputs.forEach(input => {
            const span = document.createElement('span');
            span.style.display = 'inline-block';
            span.style.width = window.getComputedStyle(input).width;
            span.style.textAlign = 'center';
            span.style.fontSize = window.getComputedStyle(input).fontSize;
            span.style.borderBottom = window.getComputedStyle(input).borderBottom;
            span.innerText = input.value;
            input.parentNode.insertBefore(span, input.nextSibling);
            input.style.display = 'none';
            tempNumSpans.push({ input: input, span: span });
        });

        document.querySelector('.utility-buttons').style.display = 'none';
        window.scrollTo(0, 0);

        html2canvas(sheet, { 
            scale: 2, 
            useCORS: true, 
            allowTaint: true,
            height: sheet.scrollHeight, 
            windowHeight: sheet.scrollHeight
        }).then(canvas => {
            const a = document.createElement('a');
            a.download = (document.getElementById('char-name').value || 'CoC') + '.png';
            a.href = canvas.toDataURL('image/png');
            a.click();

            if(txt && div) { div.style.display = 'none'; txt.style.display = 'block'; }
            tempSpans.forEach(obj => { obj.span.remove(); obj.input.style.display = ''; });
            tempNumSpans.forEach(obj => { obj.span.remove(); obj.input.style.display = ''; });
            document.querySelector('.utility-buttons').style.display = 'flex';
        });
    }
    
    function clearLocalStorage() {
        if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); }
    }

    window.onload = initSkills;
</script>
</body>
</html>