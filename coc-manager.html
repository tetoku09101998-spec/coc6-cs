<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoC Keeper Tool - Ver.22.3 (Dice Fixed)</title>
    <style>
        /* ==================== Base Styles ==================== */
        :root {
            --primary: #5c6bc0; --secondary: #3949ab; --npc-color: #ffb74d;
            --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0;
            --danger: #ef5350; --info: #42a5f5; --warn: #ffa726; --success: #66bb6a;
            --world: #8d6e63;
            --modal-bg: rgba(0, 0, 0, 0.9);
            --lib-accent: #ab47bc;
        }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; box-sizing: border-box; }
        textarea, input, button, select { font-family: inherit; }
        textarea, input[type="number"], input[type="text"], select {
            background: #2b2b2b; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 4px;
        }
        textarea:focus, input:focus { outline: 2px solid var(--info); border-color: transparent; }
        
        .container { display: grid; grid-template-columns: 350px 1fr; grid-template-rows: auto 1fr; height: 100%; }
        .header { grid-column: 1/-1; height: 50px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .sidebar { background: #181818; border-right: 1px solid #333; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .main-content { padding: 20px; overflow-y: auto; background: var(--bg); }
        .panel { background: var(--card-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); flex-shrink: 0; }
        
        /* Buttons */
        .btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; font-size: 0.9em; display: inline-flex; justify-content: center; align-items: center; text-decoration: none; transition: background 0.2s; }
        .btn:hover { opacity: 0.9; filter: brightness(1.1); }
        .btn-primary { background: var(--primary); } .btn-npc { background: var(--npc-color); color: #1e1e1e; }
        .btn-danger { background: var(--danger); } .btn-sort { background: #fff; color: #1e1e1e; }
        .btn-dark { background: #444; color: #ccc; } .btn-info { background: var(--info); width: 100%; }
        .btn-warn { background: var(--warn); color: #1e1e1e; width: 100%; } .btn-success { background: var(--success); color: #1e1e1e; width: 100%; }
        .btn-battle { background: #e53935; width: 100%; } .btn-world { background: var(--world); width: 100%; }
        .btn-lib { background: var(--lib-accent); color: white; width: 100%; }

        /* Notebook & Counters */
        .notebook { display: flex; flex-direction: column; height: 250px; }
        .nb-tabs { display: flex; gap: 2px; overflow-x: auto; border-bottom: 1px solid #444; padding-bottom: 2px; flex-shrink: 0; }
        .nb-tab { background: #2c2c2c; color: #888; padding: 5px 10px; border-radius: 4px 4px 0 0; font-size: 0.85em; cursor: pointer; white-space: nowrap; border: 1px solid transparent; }
        .nb-tab.active { background: var(--card-bg); color: var(--primary); font-weight: bold; border-color: #444; border-bottom-color: var(--card-bg); }
        .nb-tab-add { background: #333; color: var(--success); font-weight: bold; }
        .nb-content { flex-grow: 1; display: flex; flex-direction: column; padding-top: 10px; }
        .nb-textarea { flex-grow: 1; width: 100%; resize: vertical; line-height: 1.7; font-size: 0.95em; border: 1px solid #333; padding: 5px; }
        .nb-controls { display: flex; justify-content: space-between; margin-bottom: 5px; flex-shrink: 0; }
        .nb-title-input { background: transparent; border: none; border-bottom: 1px solid #555; color: white; font-weight: bold; width: 70%; }

        .counter-box { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 5px 10px; border-radius: 4px; margin-top: 5px; }
        .time-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .dice-toolbar { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .dice-btn { flex-grow: 1; background: var(--primary); color: white; border: none; padding: 8px 4px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        .dice-log { padding: 5px; background: #000; border-radius: 4px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 0.85em; border: 1px solid #333; }
        .log-entry { border-bottom: 1px solid #222; padding: 2px 0; }
        .crit { color: var(--warn); font-weight: bold; } .fumble { color: var(--danger); font-weight: bold; }

        /* Main Content & Cards */
        .control-bar { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; background: var(--card-bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; }
        .search-box { background: #333; border: 1px solid #555; color: white; padding: 5px 10px; border-radius: 4px; width: 200px; }
        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 5px; }
        .section-title { font-size: 1.3em; font-weight: bold; color: #fff; }
        .pc-title { color: var(--primary); } .npc-title { color: var(--npc-color); }
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .char-card { background: var(--card-bg); border-radius: 8px; padding: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border-top: 4px solid #555; display: flex; flex-direction: column; position: relative; transition: filter 0.3s, opacity 0.3s; }
        .char-card.acted { opacity: 0.6; filter: grayscale(0.8); border-top-color: #555 !important; }
        .card-pc { border-top-color: var(--primary); } .card-npc { border-top-color: var(--npc-color); }
        .char-remove { position: absolute; top: 5px; right: 5px; background: transparent; color: #555; border: none; cursor: pointer; font-size: 1.2em; }
        .char-header { display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 8px; padding-right: 20px; }
        .char-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--success); }
        .char-name { font-size: 1.1em; font-weight: bold; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .char-job { font-size: 0.8em; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 30%; text-align: right;}
        
        .status-badges { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        .badge { font-size: 0.7em; padding: 2px 6px; border-radius: 3px; cursor: pointer; background: #333; color: #888; border: 1px solid #444; user-select: none; }
        .badge.active { font-weight: bold; border-color: transparent; color: #1e1e1e; }
        .badge-faint.active { background: #ef5350; } .badge-insane.active { background: #ffa726; } .badge-dying.active { background: #ab47bc; color: white; } .badge-poison.active { background: #9ccc65; }
        
        /* ğŸ”¥ Layout Fix: Widened the SAN column (3rd) ğŸ”¥ */
        .status-row { display: grid; grid-template-columns: 1fr 1fr 1.3fr 0.8fr; gap: 5px; background: #252525; padding: 8px; border-radius: 4px; margin-bottom: 10px; }
        .status-item { text-align: center; display: flex; flex-direction: column; align-items: center; }
        
        /* ğŸ”¥ Input Fix: Increased max-width and min-width ğŸ”¥ */
        .status-input { width: 100%; min-width: 40px; max-width: 70px; text-align: center; font-weight: bold; font-size: 1em; background: transparent; border: none; border-bottom: 1px solid #555; padding: 2px 0; }
        
        .hp-input { color: var(--danger); } .mp-input { color: var(--info); } .san-input { color: var(--warn); }
        .sc-btn { font-size: 0.7em; padding: 1px 4px; background: #444; color: #ccc; border: 1px solid #666; border-radius: 3px; cursor: pointer; margin-top:2px; margin-left: 4px; white-space: nowrap; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 10px; text-align: center; font-size: 0.8em; }
        .stat-box { background: #333; padding: 4px 2px; border-radius: 2px; display: flex; flex-direction: column; justify-content: center; }
        .skills-list { flex-grow: 1; max-height: 120px; overflow-y: auto; font-size: 0.85em; margin-bottom: 10px; border: 1px solid #333; padding: 5px; border-radius: 4px; }
        .skill-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #2a2a2a; }
        .skill-val { font-weight: bold; color: #ccc; }
        .card-pc .skill-val { color: var(--primary); } .card-npc .skill-val { color: var(--npc-color); }
        
        .item-memo { color: #888; white-space: pre-wrap; max-height: 60px; overflow-y: auto; margin-bottom: 8px; border-bottom: 1px dashed #444; padding-bottom: 5px; font-size: 0.85em; }
        .custom-status-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 5px; background: #2c2525; padding: 8px; border-radius: 4px; margin-bottom: 10px; }
        .cs-item { display: flex; flex-direction: column; align-items: center; }
        .cs-label { font-size: 0.7em; color: var(--npc-color); margin-bottom: 2px; text-align:center; overflow:hidden; white-space:nowrap; width:100%; text-overflow:ellipsis; }
        .cs-input { width: 100%; max-width: 50px; text-align: center; font-size: 0.9em; background: transparent; border: none; border-bottom: 1px solid #666; color:#fff; }

        /* Modals & Rules */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); backdrop-filter: blur(2px); }
        .modal-content { background-color: var(--card-bg); margin: 3% auto; padding: 20px; border: 1px solid #444; border-radius: 8px; width: 90%; max-width: 800px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .tab-menu { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; background: transparent; color: #aaa; padding: 10px; cursor: pointer; border-radius: 4px 4px 0 0; text-align: center; border: 1px solid transparent; }
        .tab-btn.active { background: #252525; color: white; font-weight: bold; border-color: #444; border-bottom-color: #252525; margin-bottom: -1px; }
        .tab-content { display: none; padding: 10px; overflow-y: auto; }
        .tab-content.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Rule Elements */
        .rule-block { margin-bottom: 25px; border-left: 3px solid var(--primary); padding-left: 15px; }
        .rule-title { font-weight: bold; color: var(--primary); margin-bottom: 8px; font-size: 1.2em; border-bottom: 1px solid #333; padding-bottom: 4px; display: inline-block; }
        .rule-text { color: #ddd; font-size: 1.0em; line-height: 1.6; }
        .highlight-red { color: var(--danger); font-weight: bold; } .highlight-yellow { color: var(--warn); font-weight: bold; }
        .rule-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95em; }
        .rule-table th, .rule-table td { border: 1px solid #444; padding: 8px; text-align: left; }
        .rule-table th { background: #333; color: white; }
        .rule-table tr:nth-child(even) { background: #252525; }
        
        .skill-table { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; font-size: 0.9em; }
        .st-item { background: #252525; padding: 5px 10px; border-radius: 4px; display: flex; justify-content: space-between; }
        .st-name { color: #ccc; } .st-val { font-weight: bold; color: var(--info); }
        .insanity-row { padding: 10px; border-bottom: 1px solid #333; display: flex; gap: 15px; align-items: baseline; }
        .insanity-num { font-weight: bold; color: var(--warn); font-size: 1.2em; min-width: 30px; }
        .res-calc-box { background: #252525; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .res-table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 5px; text-align: center; font-size: 0.9em; }
        .res-cell { background: #2a2a2a; padding: 8px; border-radius: 4px; } 

        /* Library Styles */
        .lib-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
        .lib-item { background: #252525; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--lib-accent); }
        .lib-info { display: flex; flex-direction: column; }
        .lib-name { font-weight: bold; color: #fff; font-size: 1.1em; }
        .lib-meta { font-size: 0.8em; color: #888; }
        .lib-actions { display: flex; gap: 5px; }
        .drop-area { border: 2px dashed #555; padding: 20px; text-align: center; color: #aaa; margin-bottom: 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .drop-area:hover, .drop-area.dragover { border-color: var(--lib-accent); background: rgba(171, 71, 188, 0.1); color: #fff; }

        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; height: auto; display: block; overflow: auto; }
            body { overflow: auto; height: auto; }
            .sidebar { border-right: none; border-bottom: 1px solid #333; overflow: visible; height: auto; }
            .main-content { overflow: visible; height: auto; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0;">CoC Keeper Tool <span style="font-size:0.6em; color:var(--warn);">Ver.22.3 (Dice Fixed)</span></h1>
    </div>

    <div class="sidebar">
        <div class="panel">
            <h3 style="margin-top:0;">Scenario Notebook</h3>
            <div class="notebook">
                <div class="nb-tabs" id="nbTabs"><div class="nb-tab nb-tab-add" onclick="addScenarioTab()">+</div></div>
                <div class="nb-content">
                    <div class="nb-controls">
                        <input type="text" id="nbTitle" class="nb-title-input" value="Main" oninput="updateTabTitle(this.value)">
                        <button class="btn btn-danger" style="padding:2px 8px; font-size:0.7em;" onclick="deleteCurrentTab()">Del</button>
                    </div>
                    <textarea id="nbText" class="nb-textarea" oninput="updateTabContent(this.value)"></textarea>
                </div>
            </div>
        </div>

        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Round & Time</h3>
                <button class="btn btn-dark" style="font-size:0.7em; padding:2px 6px;" onclick="resetRound()">Reset</button>
            </div>
            <div class="counter-box">
                <button class="btn btn-primary" onclick="updateRound(-1)">-</button>
                <span class="round-val" id="roundDisplay" style="font-size:1.4em; font-weight:bold; color:var(--npc-color);">1</span>
                <button class="btn btn-primary" onclick="updateRound(1)">+</button>
            </div>
            <div class="counter-box" style="margin-top:10px;">
                <span class="round-val" id="timeDisplay" style="font-family:monospace; color:var(--info); font-size:1.4em; font-weight:bold;">0:00</span>
            </div>
            <div class="time-controls">
                <button class="btn btn-dark" onclick="updateTime(5)">+5m</button>
                <button class="btn btn-dark" onclick="updateTime(60)">+1h</button>
                <button class="btn btn-dark" onclick="updateTime(-5)">-5m</button>
            </div>
        </div>

        <div class="panel">
            <h3>Tools & Dice</h3>
            <div class="dice-toolbar">
                <button class="dice-btn" onclick="roll(100)">100</button>
                <button class="dice-btn" onclick="roll(10)">10</button>
                <button class="dice-btn" onclick="roll(6)">6</button>
                <button class="dice-btn" onclick="roll(3)">1d3</button>
            </div>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="customDice" placeholder="e.g. 2d6+3" style="flex:1;">
                <button class="btn btn-primary" onclick="rollCustom()">Roll</button>
            </div>
            <div class="dice-log" id="diceLog"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:10px;">
                <button class="btn btn-info" onclick="toggleModal('skillModal')">æŠ€èƒ½ä¸€è¦§</button>
                <button class="btn btn-warn" onclick="toggleModal('insanityModal')">ç‹‚æ°—è¡¨</button>
                <button class="btn btn-success" onclick="toggleModal('resistanceModal')">å¯¾æŠ—è¡¨</button>
                <button class="btn btn-battle" onclick="toggleModal('battleModal')">æˆ¦é—˜ãƒ«ãƒ¼ãƒ«</button>
                <button class="btn btn-world" onclick="toggleModal('worldModal')" style="grid-column:span 2;">ç’°å¢ƒãƒ»ç‰©ä½“</button>
            </div>
        </div>

        <div class="panel" style="background:#2a1a1a;">
            <h3 style="margin-top:0; font-size:1em; color:var(--lib-accent);">System / Library</h3>
            <button class="btn btn-lib" onclick="openLibraryModal()" style="margin-bottom:10px;">ğŸ“š Library (Save/Load)</button>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                 <button class="btn btn-npc" style="flex:1; font-size:0.8em;" onclick="toggleModal('configModal')">Config</button>
                 <button class="btn btn-danger" style="flex:1; font-size:0.8em;" onclick="resetAllData()">Reset All</button>
            </div>
            <p style="font-size:0.7em; color:#666; text-align:center; margin:0;">File Backup (Legacy)</p>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-dark" style="flex:1; font-size:0.8em;" onclick="downloadJSON()">DL JSON</button>
                <label class="btn btn-dark" style="flex:1; font-size:0.8em; cursor:pointer;">Load JSON <input type="file" accept=".json" style="display:none;" onchange="uploadJSON(this.files)"></label>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="control-bar">
            <h3 style="margin:0;">Characters</h3>
            <input type="text" id="charSearch" class="search-box" placeholder="Name Search..." oninput="renderAll()">
            
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="openLibraryModal('char', 'pc')">+ PC (Lib)</button>
                <button class="btn btn-npc" onclick="openLibraryModal('char', 'npc')">+ NPC (Lib)</button>
                <label class="btn btn-dark" style="cursor:pointer; font-size:0.9em;" title="Load from CSV File">+ PC (File) <input type="file" accept=".csv" multiple onchange="handleFiles(this.files, 'pc')" style="display:none;"></label>
                <label class="btn btn-dark" style="cursor:pointer; font-size:0.9em;" title="Load from CSV File">+ NPC (File) <input type="file" accept=".csv" multiple onchange="handleFiles(this.files, 'npc')" style="display:none;"></label>
                <button class="btn btn-sort" style="font-size:0.9em;" onclick="sortAllByDex()">Sort (DEX)</button>
            </div>
        </div>

        <div id="pcSection">
            <div class="section-header"><span class="section-title pc-title">PC</span><span style="font-size:0.8em; color:#666;" id="pcCount">(0)</span></div>
            <div id="pcContainer" class="char-grid"></div>
        </div>

        <div id="npcSection">
            <div class="section-header"><span class="section-title npc-title">NPC</span><span style="font-size:0.8em; color:#666;" id="npcCount">(0)</span></div>
            <div id="npcContainer" class="char-grid"></div>
        </div>
    </div>
</div>

<div id="libraryModal" class="modal" onclick="if(event.target == this) toggleModal('libraryModal')">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color:var(--lib-accent); margin:0;">ğŸ“š Grand Library</h2>
            <span class="close-btn" onclick="toggleModal('libraryModal')">&times;</span>
        </div>
        <div class="tab-menu">
            <div class="tab-btn active" onclick="switchTab('lib', 'scenario', this)">Scenarios</div>
            <div class="tab-btn" onclick="switchTab('lib', 'character', this)">Characters</div>
        </div>

        <div id="lib-scenario" class="tab-content active">
            <div class="rule-block" style="border-left-color:var(--lib-accent);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span class="rule-title" style="color:var(--lib-accent); border:none; margin:0;">Current Session</span>
                    <button class="btn btn-success" onclick="saveCurrentScenarioToDB()">Save Current State</button>
                </div>
                <p style="color:#aaa; font-size:0.9em; margin:0;">ç¾åœ¨é€²è¡Œä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã—ã¾ã™ã€‚</p>
            </div>
            <h3 style="color:#fff; border-bottom:1px solid #444;">Saved Scenarios</h3>
            <ul id="scenarioList" class="lib-list"></ul>
        </div>

        <div id="lib-character" class="tab-content">
            <div class="drop-area" id="charDropArea">
                <p style="margin:0; font-weight:bold;">Import CSV to Library</p>
                <span style="font-size:0.8em;">Click to select or Drop files here</span>
                <input type="file" id="libCsvInput" accept=".csv" multiple style="display:none;" onchange="importCSVToLib(this.files)">
            </div>
            <h3 style="color:#fff; border-bottom:1px solid #444;">Character Storage</h3>
            <div style="margin-bottom:10px;">
                <input type="text" id="libCharSearch" class="search-box" style="width:100%; box-sizing:border-box;" placeholder="Search stored characters..." oninput="renderLibraryCharList()">
            </div>
            <ul id="characterList" class="lib-list"></ul>
        </div>
    </div>
</div>

<div id="configModal" class="modal" onclick="if(event.target == this) toggleModal('configModal')">
    <div class="modal-content" style="max-width:500px;">
        <div class="modal-header"><h2 style="color:var(--npc-color); margin:0;">Config</h2><span class="close-btn" onclick="toggleModal('configModal')">&times;</span></div>
        <div style="display:flex; flex-direction:column; gap:15px;">
            <div><label style="color:#aaa; font-size:0.9em;">Session Title</label><input type="text" id="sessionTitleInput" style="width:100%; box-sizing:border-box; margin-top:5px;" oninput="updateSessionTitle(this.value)"></div>
            <div style="border-top:1px solid #444; padding-top:10px;">
                <h3 style="font-size:1em; color:#fff; margin-bottom:10px;">Custom Stats</h3>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div><label style="color:#888; font-size:0.8em;">Stat 1 Name</label><input type="text" id="customStat1" style="width:100%;" oninput="updateCustomStatName(0, this.value)"></div>
                    <div><label style="color:#888; font-size:0.8em;">Stat 2 Name</label><input type="text" id="customStat2" style="width:100%;" oninput="updateCustomStatName(1, this.value)"></div>
                    <div><label style="color:#888; font-size:0.8em;">Stat 3 Name</label><input type="text" id="customStat3" style="width:100%;" oninput="updateCustomStatName(2, this.value)"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="skillModal" class="modal" onclick="if(event.target == this) toggleModal('skillModal')"><div class="modal-content"><div class="modal-header"><h2 style="color:var(--info); margin:0;">æŠ€èƒ½åˆæœŸå€¤ä¸€è¦§ (6ç‰ˆ)</h2><span class="close-btn" onclick="toggleModal('skillModal')">&times;</span></div><div id="skillTable" class="skill-table"></div></div></div>
<div id="insanityModal" class="modal" onclick="if(event.target == this) toggleModal('insanityModal')"><div class="modal-content"><div class="modal-header"><h2 style="color:var(--warn); margin:0;">ç‹‚æ°—è¡¨</h2><span class="close-btn" onclick="toggleModal('insanityModal')">&times;</span></div><div class="insanity-tab" style="display:flex; gap:10px; margin-bottom:10px;"><div class="tab-btn active" onclick="switchInsanityTab('short')" id="tab-short">ä¸€æ™‚çš„ç‹‚æ°—</div><div class="tab-btn" onclick="switchInsanityTab('long')" id="tab-long">ä¸å®šã®ç‹‚æ°—</div></div><div id="insanityInfo" style="background:#252525; padding:10px; margin-bottom:10px; border-left:4px solid var(--warn); color:#ccc; white-space: pre-wrap;"></div><div style="text-align:center; margin-bottom:10px;"><button class="btn btn-warn" onclick="rollInsanity()">Roll 1D10</button><div id="insanityResult" style="margin-top:10px; font-weight:bold; color:var(--text); white-space: pre-wrap;"></div></div><div id="insanityListShort"></div><div id="insanityListLong" style="display:none;"></div></div></div>
<div id="resistanceModal" class="modal" onclick="if(event.target == this) toggleModal('resistanceModal')"><div class="modal-content"><div class="modal-header"><h2 style="color:var(--success); margin:0;">å¯¾æŠ—è¡¨</h2><span class="close-btn" onclick="toggleModal('resistanceModal')">&times;</span></div><div class="res-calc-box"><div style="display:flex; gap:20px; align-items:center; justify-content:center;"><div style="text-align:center;"><label style="font-size:0.8em; color:#aaa;">Active</label><br><input type="number" id="resActive" value="10" oninput="calcResistance()" style="width:60px; font-size:1.5em; text-align:center;"></div><div style="font-size:1.5em; font-weight:bold;">vs</div><div style="text-align:center;"><label style="font-size:0.8em; color:#aaa;">Passive</label><br><input type="number" id="resPassive" value="10" oninput="calcResistance()" style="width:60px; font-size:1.5em; text-align:center;"></div></div><div style="color:#aaa; font-size:0.9em; margin-top:10px;">æˆåŠŸç‡ = 50 + (Active - Passive) * 5</div><div class="res-result" id="resResult" style="font-size:2em; font-weight:bold; color:var(--success);">50%</div></div><div class="res-table-grid" id="resTableGrid"></div></div></div>
<div id="battleModal" class="modal" onclick="if(event.target == this) toggleModal('battleModal')"><div class="modal-content"><div class="modal-header"><h2 style="color:#e53935; margin:0;">æˆ¦é—˜ãƒ«ãƒ¼ãƒ«</h2><span class="close-btn" onclick="toggleModal('battleModal')">&times;</span></div><div class="tab-menu"><div class="tab-btn active" onclick="switchTab('battle', 'flow', this)">ãƒ•ãƒ­ãƒ¼</div><div class="tab-btn" onclick="switchTab('battle', 'attack', this)">æ”»æ’ƒãƒ»é˜²å¾¡</div><div class="tab-btn" onclick="switchTab('battle', 'damage', this)">è² å‚·</div></div><div id="battle-flow" class="tab-content active"><div class="rule-block"><div class="rule-title">1. ãƒ©ã‚¦ãƒ³ãƒ‰é€²è¡Œ</div><div class="rule-text"><ul><li>1ãƒ©ã‚¦ãƒ³ãƒ‰ = æ•°ç§’ï½10æ•°ç§’ã€‚</li><li><strong>DEXã®é«˜ã„é †</strong>ã«è¡Œå‹•ã€‚</li><li><strong>éŠƒå™¨ã®å…ˆåˆ¶</strong>: æº–å‚™æ¸ˆã¿ã®éŠƒå™¨ã¯DEXé †ã«é–¢ã‚ã‚‰ãšã‚¿ãƒ¼ãƒ³å†’é ­ã«ç™ºç ²å¯ï¼ˆDEX+50ç›¸å½“ï¼‰ã€‚</li></ul></div></div><div class="rule-block"><div class="rule-title">2. è¡Œå‹•æ¨©</div><div class="rule-text">åŸå‰‡ã¨ã—ã¦1Rã«<strong>1å›ã®èƒ½å‹•çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</strong>ï¼ˆæ”»æ’ƒã€é­”è¡“ã€é€ƒèµ°ãªã©ï¼‰ãŒå¯èƒ½ã€‚</div></div></div><div id="battle-attack" class="tab-content"><div class="rule-block"><div class="rule-title">å‘½ä¸­åˆ¤å®š</div><div class="rule-text">æŠ€èƒ½ãƒ­ãƒ¼ãƒ«æˆåŠŸã§å‘½ä¸­ã€‚<br>æ±ºå®šçš„æˆåŠŸ(01-05): å¿…ä¸­ãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸2å€ãªã©ã€‚<br>è‡´å‘½çš„å¤±æ•—(96-100): è»¢å€’ãƒ»å‘³æ–¹ã¸ã®èª¤å°„ãªã©ã€‚</div></div><div class="rule-block"><div class="rule-title">é˜²å¾¡ï¼ˆãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰</div><div class="rule-text"><ul><li><strong>å—ã‘æµã—</strong>: æ­¦å™¨/æ­¦é“ã§å¼¾ãã€‚æˆåŠŸã§ãƒ€ãƒ¡ãƒ¼ã‚¸0ã€‚1Rã«1å›ã€‚</li><li><strong>å›é¿</strong>: é¿ã‘ã‚‹ã€‚æˆåŠŸã§ãƒ€ãƒ¡ãƒ¼ã‚¸0ã€‚1Rã«1å›ã€‚</li><li>â€»éŠƒå¼¾ã¯åŸå‰‡ã€å—ã‘æµã—ãƒ»å›é¿ä¸å¯ã€‚</li></ul></div></div></div><div id="battle-damage" class="tab-content"><div class="rule-block"><div class="rule-title">ç”Ÿæ­»</div><div class="rule-text"><ul><li><strong>HP 0</strong>: æ¬¡Rçµ‚äº†æ™‚ã«æ­»äº¡ï¼ˆæ²»ç™‚ãªã‘ã‚Œã°ï¼‰ã€‚</li><li><strong>HP 2ä»¥ä¸‹</strong>: æ°—çµ¶ã€‚</li><li><strong>ã‚·ãƒ§ãƒƒã‚¯</strong>: ä¸€æ’ƒã§æœ€å¤§HPã®åŠåˆ†ä»¥ä¸Šâ†’CON*5å¤±æ•—ã§æ°—çµ¶ã€‚</li><li><strong>ãƒãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</strong>: å®£è¨€ã—ã¦æ”»æ’ƒã€‚å¯¾è±¡HPä»¥ä¸‹ãªã‚‰æ°—çµ¶ã€‚</li></ul></div></div></div></div></div>

<div id="worldModal" class="modal" onclick="if(event.target == this) toggleModal('worldModal')"><div class="modal-content"><div class="modal-header"><h2 style="color:var(--world); margin:0;">ç’°å¢ƒãƒ»ç‰©ä½“ (World Rules)</h2><span class="close-btn" onclick="toggleModal('worldModal')">&times;</span></div><div class="tab-menu"><div class="tab-btn active" onclick="switchTab('world', 'env', this)">ç’°å¢ƒãƒ€ãƒ¡ãƒ¼ã‚¸</div><div class="tab-btn" onclick="switchTab('world', 'obj', this)">ç‰©ä½“ã®å¼·åº¦</div></div><div id="world-env" class="tab-content active"><div class="rule-block"><div class="rule-title">è½ä¸‹ (Falling)</div><div class="rule-text">è½ä¸‹è·é›¢ 3m (10ãƒ•ã‚£ãƒ¼ãƒˆ) ã”ã¨ã« <strong>1D6</strong> ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚<table class="rule-table"><tr><th>è·é›¢</th><th>ãƒ€ãƒ¡ãƒ¼ã‚¸</th><th>å‚™è€ƒ</th></tr><tr><td>3m (2éš)</td><td>1D6</td><td>[è·³èº]æˆåŠŸã§è»½æ¸›å¯ã®å ´åˆã‚‚</td></tr><tr><td>6m (3éš)</td><td>2D6</td><td></td></tr><tr><td>12m (5éš)</td><td>4D6</td><td></td></tr><tr><td>20mä»¥ä¸Š</td><td>20D6</td><td>ã»ã¼å³æ­»</td></tr></table></div></div><div class="rule-block"><div class="rule-title">ç«ãƒ»ç†± (Fire)</div><div class="rule-text"><table class="rule-table"><tr><th>ç«ã®å¤§ãã•</th><th>ãƒ€ãƒ¡ãƒ¼ã‚¸</th></tr><tr><td>æ¾æ˜ãƒ»ç«ã®ã¤ã„ãŸæ£’</td><td>1D6</td></tr><tr><td>ãŸãç«ãƒ»ç«ç‚æ”¾å°„å™¨</td><td>2D6</td></tr><tr><td>ç‡ƒãˆç››ã‚‹éƒ¨å±‹</td><td>1D6ã€œ3D6 / ãƒ©ã‚¦ãƒ³ãƒ‰</td></tr></table>â€»è¡£æœã¸ã®å¼•ç«ï¼š[å¹¸é‹]å¤±æ•—ã§å¼•ç«ã€æ¯ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹ã€‚</div></div><div class="rule-block"><div class="rule-title">çª’æ¯ãƒ»æººã‚Œ (Suffocation)</div><div class="rule-text">1. [CONÃ—10]åˆ¤å®šã‹ã‚‰é–‹å§‹ã€‚<br>2. æ¯ãƒ©ã‚¦ãƒ³ãƒ‰å€ç‡ã‚’ä¸‹ã’ã¦åˆ¤å®š (Ã—9, Ã—8, ...)ã€‚<br>3. å¤±æ•—ã™ã‚‹ã¨å‘¼å¸ã—ã‚ˆã†ã¨ã—ã¦æ°´ã‚’å¸ã„è¾¼ã¿ã€æ¯ãƒ©ã‚¦ãƒ³ãƒ‰ <strong>1D6</strong> ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚</div></div></div><div id="world-obj" class="tab-content"><div class="rule-block"><div class="rule-title">ç‰©ä½“ã®STRï¼ˆå¯¾æŠ—ãƒ­ãƒ¼ãƒ«ç”¨ï¼‰</div><div class="rule-text">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®STRã¨å¯¾æŠ—ãƒ­ãƒ¼ãƒ«ã‚’è¡Œã†éš›ã®ç›®å®‰ã€‚<br>æˆåŠŸç‡ = 50 + (è‡ªåˆ†ã®STR - ç‰©ä½“ã®STR) Ã— 5<table class="rule-table"><tr><th>ç‰©ä½“</th><th>STR</th><th>å‚™è€ƒ</th></tr><tr><td>ã‚¬ãƒ©ã‚¹çª“ãƒ»è–„ã„æ¿</td><td>3 ã€œ 5</td><td>ç°¡å˜ã«å‰²ã‚Œã‚‹</td></tr><tr><td>æœ¨è£½ã®æ¤…å­</td><td>10</td><td>æ­¦å™¨ã«ã‚‚ãªã‚‹</td></tr><tr><td>æœ¨è£½ã®ãƒ‰ã‚¢ï¼ˆè–„ï¼‰</td><td>10 ã€œ 15</td><td>è¹´ç ´ã‚Œã‚‹ã‹ã‚‚</td></tr><tr><td>æœ¨è£½ã®ãƒ‰ã‚¢ï¼ˆåš/é ‘ä¸ˆï¼‰</td><td>20 ã€œ 25</td><td>æ–§ãŒå¿…è¦</td></tr><tr><td>é‰„ã®æ‰‰ãƒ»æ‰‹éŒ </td><td>40 ã€œ 50</td><td>äººé–“ã«ã¯ä¸å¯èƒ½ã«è¿‘ã„</td></tr><tr><td>ãƒ­ãƒ¼ãƒ—ï¼ˆéº»ï¼‰</td><td>10 ã€œ 15</td><td></td></tr><tr><td>æ‰‹éŒ ï¼ˆé‡‘å±ï¼‰</td><td>50+</td><td>éµé–‹ã‘æ¨å¥¨</td></tr></table></div></div></div></div></div>

<script>
/**
 * ============================================================
 * ğŸ© CoC Data Manager Library
 * ============================================================
 */
class CoCDataManager {
    constructor() { this.PREFIX_CHAR = 'coc_char_'; this.PREFIX_SCENE = 'coc_scene_'; }
    generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
    parseCSV(csvText) {
        const data = {};
        csvText.split(/\r?\n/).forEach((row, i) => {
            if (i === 0 || !row.trim()) return;
            const idx = row.indexOf(',');
            if(idx === -1) return;
            const id = row.substring(0, idx);
            const val = row.substring(idx+1).replace(/^"|"$/g, '').replace(/""/g, '"').replace(/\\n/g, '\n');
            data[id] = val;
        });
        return data;
    }
    // Character Methods
    saveCharacterFromCSV(csvText) {
        const data = this.parseCSV(csvText);
        const name = data['char-name'] || 'Unknown';
        const record = { id: this.generateId(), type: 'character', name: name, job: data['char-job']||'', updatedAt: new Date().toISOString(), data: data };
        localStorage.setItem(this.PREFIX_CHAR + record.id, JSON.stringify(record));
        return record.id;
    }
    getCharacterList() {
        const list = [];
        for (let i=0; i<localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(this.PREFIX_CHAR)) {
                try { const item = JSON.parse(localStorage.getItem(key)); list.push(item); } catch(e){}
            }
        }
        return list.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
    }
    getCharacter(id) { const json = localStorage.getItem(this.PREFIX_CHAR + id); return json ? JSON.parse(json) : null; }
    deleteCharacter(id) { localStorage.removeItem(this.PREFIX_CHAR + id); }
    // Scenario Methods
    saveScenario(stateObj) {
        const title = stateObj.sessionTitle || "Untitled Session";
        const id = stateObj.scenarioId || this.generateId();
        stateObj.scenarioId = id;
        const record = { id: id, type: 'scenario', title: title, updatedAt: new Date().toISOString(), data: stateObj };
        localStorage.setItem(this.PREFIX_SCENE + id, JSON.stringify(record));
        return id;
    }
    getScenarioList() {
        const list = [];
        for (let i=0; i<localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(this.PREFIX_SCENE)) {
                try { const item = JSON.parse(localStorage.getItem(key)); list.push(item); } catch(e){}
            }
        }
        return list.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
    }
    getScenario(id) { const json = localStorage.getItem(this.PREFIX_SCENE + id); return json ? JSON.parse(json) : null; }
    deleteScenario(id) { localStorage.removeItem(this.PREFIX_SCENE + id); }
}

/**
 * ============================================================
 * ğŸ® Application Logic (Ver 22.3)
 * ============================================================
 */
const STORAGE_KEY = 'coc_tool_state_v22_3'; // Key Update
const db = new CoCDataManager();
let appState = { 
    scenarioId: null, 
    round: 1, 
    timeMinutes: 0, 
    scenarioTabs: [{id: 'main', title: 'Main', content: ''}], 
    activeTabId: 'main', 
    sessionTitle: "",
    customStats: ["", "", ""],
    pcs: [], npcs: [] 
};

window.onload = function() { loadState(); initSkillTable(); initInsanityTables(); switchInsanityTab('short'); initResistanceTable(); setupDragDrop(); };

function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }
function loadState() {
    const s = localStorage.getItem(STORAGE_KEY);
    if(s) try { appState = { ...appState, ...JSON.parse(s) }; } catch(e){console.error(e);}
    if(!appState.scenarioTabs) appState.scenarioTabs=[{id:'main',title:'Main',content:''}];
    if(!appState.customStats) appState.customStats=["","",""];
    
    document.getElementById('roundDisplay').textContent=appState.round||1; 
    document.getElementById('sessionTitleInput').value=appState.sessionTitle||""; 
    [0,1,2].forEach(i => document.getElementById(`customStat${i+1}`).value = appState.customStats[i] || "");
    renderTime(); renderAll(); renderNotebook();
}

// Library Integration
let pendingLibAddType = 'pc';
function openLibraryModal(mode = 'scenario', type = 'pc') {
    toggleModal('libraryModal');
    if(mode === 'char') {
        pendingLibAddType = type;
        switchTab('lib', 'character', document.querySelectorAll('#libraryModal .tab-btn')[1]);
    } else {
        switchTab('lib', 'scenario', document.querySelectorAll('#libraryModal .tab-btn')[0]);
    }
    renderLibraryScenarioList();
    renderLibraryCharList();
}
function saveCurrentScenarioToDB() { const id = db.saveScenario(appState); appState.scenarioId = id; saveState(); alert(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€Œ${appState.sessionTitle || 'ç„¡é¡Œ'}ã€ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã—ã¾ã—ãŸï¼`); renderLibraryScenarioList(); }
function loadScenarioFromDB(id) { if(!confirm("ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç ´æ£„ã—ã¦ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ")) return; const rec = db.getScenario(id); if(rec && rec.data) { appState = rec.data; appState.scenarioId = rec.id; saveState(); renderNotebook(); renderTime(); renderAll(); document.getElementById('sessionTitleInput').value = appState.sessionTitle; [0,1,2].forEach(i => document.getElementById(`customStat${i+1}`).value = appState.customStats[i] || ""); toggleModal('libraryModal'); alert(`ã€Œ${rec.title}ã€ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`); } }
function deleteScenarioFromDB(id) { if(confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { db.deleteScenario(id); renderLibraryScenarioList(); } }
function renderLibraryScenarioList() { const list = db.getScenarioList(); const ul = document.getElementById('scenarioList'); ul.innerHTML = list.length === 0 ? '<li style="color:#666; text-align:center;">No Scenarios Saved</li>' : ''; list.forEach(item => { const li = document.createElement('li'); li.className = 'lib-item'; li.innerHTML = `<div class="lib-info"><span class="lib-name">${item.title}</span><span class="lib-meta">${new Date(item.updatedAt).toLocaleString()}</span></div><div class="lib-actions"><button class="btn btn-primary" onclick="loadScenarioFromDB('${item.id}')">Load</button><button class="btn btn-danger" onclick="deleteScenarioFromDB('${item.id}')">Del</button></div>`; ul.appendChild(li); }); }
function importCSVToLib(files) { Array.from(files).forEach(f => { const r = new FileReader(); r.onload = e => { db.saveCharacterFromCSV(e.target.result); renderLibraryCharList(); }; r.readAsText(f); }); }
function setupDragDrop() { const da = document.getElementById('charDropArea'); const inp = document.getElementById('libCsvInput'); da.onclick = () => inp.click(); da.ondragover = e => { e.preventDefault(); da.classList.add('dragover'); }; da.ondragleave = () => da.classList.remove('dragover'); da.ondrop = e => { e.preventDefault(); da.classList.remove('dragover'); if(e.dataTransfer.files.length) importCSVToLib(e.dataTransfer.files); }; }
function renderLibraryCharList() { const q = document.getElementById('libCharSearch').value.toLowerCase(); const list = db.getCharacterList().filter(c => c.name.toLowerCase().includes(q)); const ul = document.getElementById('characterList'); ul.innerHTML = list.length === 0 ? '<li style="color:#666; text-align:center;">No Characters</li>' : ''; list.forEach(item => { const li = document.createElement('li'); li.className = 'lib-item'; li.style.borderLeftColor = 'var(--info)'; li.innerHTML = `<div class="lib-info"><span class="lib-name">${item.name}</span><span class="lib-meta">${item.job} | ${new Date(item.updatedAt).toLocaleDateString()}</span></div><div class="lib-actions"><button class="btn ${pendingLibAddType==='pc'?'btn-primary':'btn-npc'}" onclick="addCharToSession('${item.id}')">+ ${pendingLibAddType.toUpperCase()}</button><button class="btn btn-danger" onclick="deleteCharFromDB('${item.id}')">Del</button></div>`; ul.appendChild(li); }); }
function addCharToSession(dbId) { const rec = db.getCharacter(dbId); if(rec) { addChar(rec.data, pendingLibAddType); alert(`ã€Œ${rec.name}ã€ã‚’ ${pendingLibAddType.toUpperCase()} ã¨ã—ã¦è¿½åŠ ã—ã¾ã—ãŸã€‚`); } }
function deleteCharFromDB(id) { if(confirm("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { db.deleteCharacter(id); renderLibraryCharList(); } }

// Legacy & UI
function addChar(d, t){ const id=Date.now()+Math.random().toString(36).substr(2,9); let hp=d['hp-current']; if(hp===undefined||hp==="") hp=d['hp-max']||0; const c={id, type:t, data:d, current:{hp, mp:d['mp']||0, san:d['san']||0, kpMemo:"", acted:false, statuses:[], customVals:[0,0,0]}}; if(t==='pc') appState.pcs.push(c); else appState.npcs.push(c); saveState(); renderAll(); }
function handleFiles(fs, t){ Array.from(fs).forEach(f=>{ const r=new FileReader(); r.onload=e=>addChar(db.parseCSV(e.target.result), t); r.readAsText(f); }); document.querySelectorAll('input[type="file"]').forEach(i=>i.value=''); }
function downloadJSON(){ const n = (appState.sessionTitle||"coc_session").replace(/[\\/:*?"<>|]/g,"_")+"_"+new Date().toISOString().slice(0,10)+".json"; const a = document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appState)); a.download=n; document.body.appendChild(a); a.click(); a.remove(); }
function uploadJSON(f){ if(f.length===0)return; const r=new FileReader(); r.onload=e=>{ if(confirm("ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ")){ appState=JSON.parse(e.target.result); saveState(); location.reload(); } }; r.readAsText(f[0]); }
function resetAllData(){ if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
function updateSessionTitle(v) { appState.sessionTitle=v; saveState(); }
function updateCustomStatName(idx, v) { appState.customStats[idx] = v; saveState(); renderAll(); }
function updateRound(d){ let v=appState.round||1; v+=d; if(v<1)v=1; appState.round=v; if(d>0){appState.pcs.forEach(c=>c.current.acted=false);appState.npcs.forEach(c=>c.current.acted=false);} document.getElementById('roundDisplay').textContent=v; saveState(); renderAll(); }
function resetRound(){ appState.round=1; document.getElementById('roundDisplay').textContent=1; saveState(); }
function updateTime(m){ if(!appState.timeMinutes)appState.timeMinutes=0; appState.timeMinutes+=m; if(appState.timeMinutes<0)appState.timeMinutes=0; renderTime(); saveState(); }
function renderTime(){ const t=appState.timeMinutes||0, h=Math.floor(t/60), m=t%60; document.getElementById('timeDisplay').textContent=`${h}:${m<10?"0"+m:m}`; }
function renderNotebook(){ const c=document.getElementById('nbTabs'); const btn=c.querySelector('.nb-tab-add'); c.innerHTML=''; appState.scenarioTabs.forEach(t=>{ const d=document.createElement('div'); d.className=`nb-tab ${t.id===appState.activeTabId?'active':''}`; d.textContent=t.title; d.onclick=()=>switchNbTab(t.id); c.appendChild(d); }); c.appendChild(btn); const act=appState.scenarioTabs.find(t=>t.id===appState.activeTabId)||appState.scenarioTabs[0]; document.getElementById('nbTitle').value=act.title; document.getElementById('nbText').value=act.content; }
function switchNbTab(id){ appState.activeTabId=id; renderNotebook(); saveState(); }
function addScenarioTab(){ const id='tab-'+Date.now(); appState.scenarioTabs.push({id,title:'New',content:''}); switchNbTab(id); }
function deleteCurrentTab(){ if(appState.scenarioTabs.length<=1)return; if(!confirm("å‰Šé™¤ï¼Ÿ"))return; appState.scenarioTabs=appState.scenarioTabs.filter(t=>t.id!==appState.activeTabId); appState.activeTabId=appState.scenarioTabs[0].id; renderNotebook(); saveState(); }
function updateTabTitle(v){ const t=appState.scenarioTabs.find(x=>x.id===appState.activeTabId); if(t){t.title=v; saveState(); renderNotebook();} }
function updateTabContent(v){ const t=appState.scenarioTabs.find(x=>x.id===appState.activeTabId); if(t){t.content=v; saveState();} }

// Rendering
const baseSkills={ "è¨€ã„ãã‚‹ã‚": 5, "åŒ»å­¦": 5, "é‹è»¢": 20, "å¿œæ€¥æ‰‹å½“": 30, "ã‚ªã‚«ãƒ«ãƒˆ": 5, "å›é¿": "DEX*2", "åŒ–å­¦": 1, "éµé–‹ã‘": 1, "éš ã™": 15, "éš ã‚Œã‚‹": 10, "æ©Ÿæ¢°ä¿®ç†": 20, "èãè€³": 25, "ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ç¥è©±": 0, "èŠ¸è¡“": 5, "çµŒç†": 10, "è€ƒå¤å­¦": 1, "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼": 1, "å¿ã³æ­©ã": 10, "å†™çœŸè¡“": 10, "é‡æ©Ÿæ¢°æ“ä½œ": 1, "ä¹—é¦¬": 5, "ä¿¡ç”¨": 15, "å¿ƒç†å­¦": 5, "äººé¡å­¦": 1, "æ°´æ³³": 25, "è£½ä½œ": 5, "ç²¾ç¥åˆ†æ": 1, "ç”Ÿç‰©å­¦": 1, "èª¬å¾—": 15, "æ“ç¸¦": 1, "åœ°è³ªå­¦": 1, "è·³èº": 25, "è¿½è·¡": 10, "é›»æ°—ä¿®ç†": 10, "é›»å­å·¥å­¦": 1, "å¤©æ–‡å­¦": 1, "æŠ•æ“²": 25, "ç™»æ”€": 40, "å›³æ›¸é¤¨": 25, "ãƒŠãƒ“ã‚²ãƒ¼ãƒˆ": 10, "å€¤åˆ‡ã‚Š": 5, "åšç‰©å­¦": 10, "ç‰©ç†å­¦": 1, "å¤‰è£…": 1, "æ³•å¾‹": 5, "æ¯å›½èª": "EDU*5", "ç›®æ˜Ÿ": 25, "è–¬å­¦": 1, "æ­´å²": 20, "æ‹³éŠƒ": 20, "ã‚µãƒ–ãƒã‚·ãƒ³ã‚¬ãƒ³": 15, "ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³": 30, "ãƒã‚·ãƒ³ã‚¬ãƒ³": 15, "ãƒ©ã‚¤ãƒ•ãƒ«": 25, "ã‚­ãƒƒã‚¯": 25, "çµ„ã¿ä»˜ã": 25, "ã“ã¶ã—": 50, "é ­çªã": 10 };
function escapeHtml(u) { if(!u)return""; return String(u).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
function renderAll(){ const q = document.getElementById('charSearch').value.toLowerCase(); const f = (list) => list.filter(c => (c.data['char-name']||"").toLowerCase().includes(q)); renderList(f(appState.pcs), 'pcContainer', 'pc'); renderList(f(appState.npcs), 'npcContainer', 'npc'); document.getElementById('pcCount').textContent=`(${appState.pcs.length})`; document.getElementById('npcCount').textContent=`(${appState.npcs.length})`; }
function renderList(l, cid, t){ const c=document.getElementById(cid); c.innerHTML=''; l.forEach(x=>c.appendChild(createCard(x, t))); }
function createCard(c, t){
    const d=c.data, cur=c.current;
    const name=escapeHtml(d['char-name']||"No Name"); const job=escapeHtml(d['char-job']||"");
    const stats=['str','con','siz','int','pow','dex','app','edu']; const sv={}; stats.forEach(s=>sv[s]=parseInt(d[s])||0);
    let db = d['db']; if(!db) { const total = sv.str + sv.siz; if(total<=12) db="-1D6"; else if(total<=16) db="-1D4"; else if(total<=24) db="0"; else if(total<=32) db="+1D4"; else if(total<=40) db="+1D6"; else db="+2D6"; }
    let hpMax = d['hp-max']; if(!hpMax || hpMax==0) hpMax = Math.ceil((sv.con + sv.siz)/2);
    const sl=[]; const sk=Object.keys(d).filter(k=>k.startsWith('s-')); const sn=new Set(sk.map(k=>k.split('-')[1]));
    sn.forEach(n=>{ const v=parseInt(d[`s-${n}-job`]||0)+parseInt(d[`s-${n}-hobby`]||0)+parseInt(d[`s-${n}-growth`]||0); const sub = d[`s-${n}-sub`]; let displayName = n; if(sub) displayName += `(${sub})`; let b=(typeof baseSkills[n]==='number')?baseSkills[n]:0; if(b===-1)b=0; if(v>0 || baseSkills[n]===-1 || baseSkills[n]==="DEX*2" || baseSkills[n]==="EDU*5"){ let base=b; if(n==="å›é¿")base=sv.dex*2; if(n==="æ¯å›½èª")base=sv.edu*5; if(v>0) sl.push({n: displayName, v:base+v}); } }); sl.sort((a,b)=>b.v-a.v);
    const card=document.createElement('div'); card.className=`char-card card-${t} ${cur.acted?'acted':''}`;
    const badges=[{id:'faint',l:'æ°—çµ¶',c:'badge-faint'},{id:'insane',l:'ç™ºç‹‚',c:'badge-insane'},{id:'dying',l:'ç€•æ­»',c:'badge-dying'},{id:'poison',l:'æ¯’',c:'badge-poison'}].map(b=>`<span class="badge ${b.c} ${(cur.statuses||[]).includes(b.id)?'active':''}" onclick="toggleStatus('${c.id}','${t}','${b.id}')">${b.l}</span>`).join('');
    let memo=escapeHtml(d['items-memo']||"ãªã—").replace(/\\n/g,'\n');
    let customStatsHtml = ""; if(appState.customStats.some(n=>n)) { let items = ""; appState.customStats.forEach((n, idx) => { if(n) { const val = (cur.customVals && cur.customVals[idx]) || 0; items += `<div class="cs-item"><span class="cs-label" title="${escapeHtml(n)}">${escapeHtml(n)}</span><input type="number" class="cs-input" value="${val}" oninput="updateCustomVal('${c.id}','${t}',${idx},this.value)"></div>`; }}); if(items) customStatsHtml = `<div class="custom-status-row">${items}</div>`; }
    card.innerHTML = `<button class="char-remove" onclick="removeCharacter('${c.id}','${t}')">Ã—</button><div class="char-header"><input type="checkbox" class="char-checkbox" ${cur.acted?'checked':''} onclick="toggleActed('${c.id}','${t}')"><span class="char-name" title="${name}">${name}</span><span class="char-job">${job}</span></div><div class="status-badges">${badges}</div>${customStatsHtml}<div class="status-row"><div class="status-item"><span class="status-label">HP</span><div style="display:flex;align-items:center;"><input type="number" class="status-input hp-input" value="${cur.hp}" oninput="updateCharStatus('${c.id}','${t}','hp',this.value)"><span style="font-size:0.8em;color:#888;">/${hpMax}</span></div></div><div class="status-item"><span class="status-label">MP</span><input type="number" class="status-input mp-input" value="${cur.mp}" oninput="updateCharStatus('${c.id}','${t}','mp',this.value)"></div><div class="status-item"><span class="status-label">SAN</span><div style="display:flex;align-items:center;"><input type="number" class="status-input san-input" value="${cur.san}" oninput="updateCharStatus('${c.id}','${t}','san',this.value)"><button class="sc-btn" onclick="rollSC('${c.id}','${t}')">SC</button></div></div><div class="status-item"><span class="status-label">DB</span><span style="font-weight:bold;">${db}</span></div></div><div class="stats-grid">${stats.map(s=>`<div class="stat-box"><span class="stat-name">${s.toUpperCase()}</span><strong>${sv[s]}</strong></div>`).join('')}</div><div class="skills-list">${sl.map(s=>`<div class="skill-row"><span class="skill-name">${s.n}</span><span class="skill-val">${s.v}%</span></div>`).join('')||'<div style="text-align:center;color:#666">No Skills</div>'}</div><div style="font-size:0.8em; border-top:1px solid #444; padding-top:5px;"><span style="color:#888;">æ‰€æŒå“/ãƒ¡ãƒ¢:</span><div class="item-memo">${memo}</div><span style="color:#888;">KPãƒ¡ãƒ¢:</span><textarea style="width:100%; height:40px;" oninput="updateCharStatus('${c.id}','${t}','kpMemo',this.value)">${escapeHtml(cur.kpMemo)}</textarea></div>`;
    return card;
}

function removeCharacter(id, t){ if(confirm("å‰Šé™¤ï¼Ÿ")){ if(t==='pc') appState.pcs=appState.pcs.filter(c=>c.id!==id); else appState.npcs=appState.npcs.filter(c=>c.id!==id); saveState(); renderAll(); } }
function updateCharStatus(id, t, f, v){ const l=t==='pc'?appState.pcs:appState.npcs; const c=l.find(i=>i.id===id); if(c){c.current[f]=v; saveState();} }
function updateCustomVal(id, t, idx, v){ const l=t==='pc'?appState.pcs:appState.npcs; const c=l.find(i=>i.id===id); if(c){ if(!c.current.customVals) c.current.customVals=[0,0,0]; c.current.customVals[idx]=v; saveState(); } }
function toggleActed(id,t){ const l=t==='pc'?appState.pcs:appState.npcs; const c=l.find(i=>i.id===id); if(c){c.current.acted=!c.current.acted; saveState(); renderAll();} }
function toggleStatus(id,t,s){ const l=t==='pc'?appState.pcs:appState.npcs; const c=l.find(i=>i.id===id); if(c){ if(!c.current.statuses)c.current.statuses=[]; const i=c.current.statuses.indexOf(s); if(i>-1)c.current.statuses.splice(i,1); else c.current.statuses.push(s); saveState(); renderAll(); } }
function sortAllByDex(){ const s=(a,b)=>(parseInt(b.data['dex'])||0)-(parseInt(a.data['dex'])||0); appState.pcs.sort(s); appState.npcs.sort(s); saveState(); renderAll(); }
function roll(s){ logDice(s===100?'1d100':'1d'+s, Math.floor(Math.random()*s)+1); }
function rollCustom(){ const i=document.getElementById('customDice').value; try { const f=new Function('return '+i.replace(/(\d+)d(\d+)/g, '(Array.from({length:$1},()=>Math.floor(Math.random()*$2)+1).reduce((a,b)=>a+b,0))')); const r=f(); logDice(i, r); } catch(e){ alert("Invalid Dice Formula"); } }
function logDice(txt, res){ const l=document.getElementById('diceLog'); const n=new Date().toLocaleTimeString('ja-JP',{hour12:false}); const e=document.createElement('div'); e.className="log-entry"; let x=""; if(txt==='1d100'){if(res<=5)x="crit"; if(res>=96)x="fumble";} e.innerHTML=`<span style="color:#666">[${n}]</span> ${txt} â†’ <span class="${x}">${res}</span>${x? (x==="crit"?" (C)":" (F)"):""}`; l.insertBefore(e,l.firstChild); }
function rollSC(id, t) { const l=t==='pc'?appState.pcs:appState.npcs; const c=l.find(i=>i.id===id); const cur=parseInt(c.current.san); const res=Math.floor(Math.random()*100)+1; const s=res<=cur; const msg=`SAN Check (${c.data['char-name']}): ${res} <= ${cur} ... ${s?"æˆåŠŸ":"å¤±æ•—"}`; logDice(msg, res); alert(msg + (s ? "\næˆåŠŸï¼æ¸›å°‘ã¯è»½å¾®ã€‚" : "\nå¤±æ•—ï¼æ­£æ°—åº¦ãŒæ¸›å°‘ã€‚")); }

// Modal & Utils
let curIns='short';
const insanityShort=[{d:1,text:"æ°—çµ¶/é‡‘åˆ‡ã‚Šå£°"},{d:2,text:"ãƒ‘ãƒ‹ãƒƒã‚¯ãƒ»é€ƒèµ°"},{d:3,text:"è‚‰ä½“çš„ãƒ’ã‚¹ãƒ†ãƒªãƒ¼"},{d:4,text:"å¤šå¼ç—‡"},{d:5,text:"é‡‘ç¸›ã‚Š"},{d:6,text:"ååŸ·ç—‡ãƒ»å¦„æƒ³"},{d:7,text:"ææ€–ç—‡"},{d:8,text:"å¼·è¿«è¦³å¿µ"},{d:9,text:"ç•°é£Ÿç—‡"},{d:10,text:"æ˜è¿·"}];
const insanityLong=[{d:1,text:"å¥å¿˜ç—‡"},{d:2,text:"å¿ƒå› æ€§èº«ä½“éšœå®³"},{d:3,text:"æš´åŠ›è¡å‹•"},{d:4,text:"ååŸ·ç—‡"},{d:5,text:"ä¾å­˜ãƒ»åŸ·ç€"},{d:6,text:"æ°—çµ¶ãƒ»å¤±ç¥"},{d:7,text:"ãƒ‘ãƒ‹ãƒƒã‚¯é€ƒäº¡"},{d:8,text:"è‚‰ä½“çš„ãƒ’ã‚¹ãƒ†ãƒªãƒ¼"},{d:9,text:"ææ€–ç—‡"},{d:10,text:"ãƒ•ã‚§ãƒ†ã‚£ã‚·ã‚ºãƒ "}];
function toggleModal(id){ const m=document.getElementById(id); m.style.display=(m.style.display==="flex"?"none":"flex"); }
function switchTab(p,n,b){ const m=document.getElementById(p+'Modal') || document.getElementById('libraryModal') || document.getElementById('worldModal') || document.getElementById('battleModal'); m.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); m.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.getElementById(p+'-'+n).classList.add('active'); }
function switchInsanityTab(t){ curIns=t; document.getElementById('tab-short').className=`tab-btn ${t==='short'?'active':''}`; document.getElementById('tab-long').className=`tab-btn ${t==='long'?'active':''}`; document.getElementById('insanityListShort').style.display=t==='short'?'block':'none'; document.getElementById('insanityListLong').style.display=t==='long'?'block':'none'; document.getElementById('insanityInfo').innerText={short:"æ¡ä»¶: SAN5ä»¥ä¸Šæ¸›å°‘ + [ã‚¢ã‚¤ãƒ‡ã‚¢]æˆåŠŸ\næœŸé–“: 1D10+4R",long:"æ¡ä»¶: 1æ™‚é–“ä»¥å†…ã«SAN20%æ¸›å°‘\næœŸé–“: 1D10Ã—10æ™‚é–“"}[t]; }
function initInsanityTables(){ const r=(l,c)=>{ document.getElementById(c).innerHTML=l.map(i=>`<div class="insanity-row"><div class="insanity-num">${i.d}</div><div>${i.text}</div></div>`).join(''); }; r(insanityShort,'insanityListShort'); r(insanityLong,'insanityListLong'); }
function rollInsanity(){ const r=Math.floor(Math.random()*10)+1; const l=curIns==='short'?insanityShort:insanityLong; document.getElementById('insanityResult').innerText=`ã€çµæœ: ${r}ã€‘\n${l.find(x=>x.d===r).text}`; }
function calcResistance(){ const a=parseInt(document.getElementById('resActive').value)||0, p=parseInt(document.getElementById('resPassive').value)||0; document.getElementById('resResult').textContent=`${Math.min(100,Math.max(0,50+(a-p)*5))}%`; }
function initResistanceTable(){ let h=""; for(let d=-9;d<=9;d++)h+=`<div class="res-cell"><div class="res-target">${50+d*5}%</div><div style="font-size:0.7em;color:#888;">${d>0?'+'+d:d}</div></div>`; document.getElementById('resTableGrid').innerHTML=h; }
function initSkillTable(){ const k=Object.keys(baseSkills).sort((a,b)=>a.localeCompare(b,'ja')); document.getElementById('skillTable').innerHTML=k.map(x=>{ let v=baseSkills[x]; if(typeof v==='number'&&v!==-1)v+="%"; return `<div class="st-item"><span class="st-name">${x}</span><span class="st-val">${v}</span></div>`; }).join(''); }
</script>
</body>
</html>